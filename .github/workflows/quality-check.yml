# ğŸ§ª Universal Mobile App Quality Check Workflow
# Template for automatic quality checks on PR and pushes

name: ğŸ§ª Quality Check

# Trigger on PRs and pushes to main
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

  # Allows manual triggering
  workflow_dispatch:

jobs:
  quality-check:
    name: ğŸ§ª Quality & Security Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“„ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ” Run ESLint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint
          echo "âœ… ESLint passed!"

      - name: ğŸ—ï¸ TypeScript check
        run: |
          echo "ğŸ—ï¸ Running TypeScript check..."
          npx tsc --noEmit
          echo "âœ… TypeScript check passed!"

      - name: ğŸ’ Prettier check
        run: |
          echo "ğŸ’ Checking code formatting..."
          npx prettier --check .
          echo "âœ… Code formatting is correct!"

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level moderate
          echo "âœ… No security vulnerabilities found!"

      - name: ğŸ“± Expo configuration check
        run: |
          echo "ğŸ“± Checking Expo configuration..."
          npx expo config --type public > /dev/null
          echo "âœ… Expo configuration is valid!"

      - name: ğŸ§ª Environment variables check
        run: |
          echo "ğŸ§ª Checking environment setup..."

          # Check for required files
          if [ ! -f "app.json" ]; then
            echo "âŒ app.json not found"
            exit 1
          fi

          if [ ! -f "eas.json" ]; then
            echo "âŒ eas.json not found"
            exit 1
          fi

          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found"
            exit 1
          fi

          echo "âœ… Environment configuration verified!"

      - name: ğŸ“Š Generate quality report
        if: always()
        run: |
          echo "ğŸ“Š Quality Check Report" > quality-report.md
          echo "=======================" >> quality-report.md
          echo "" >> quality-report.md
          echo "**Commit:** ${{ github.sha }}" >> quality-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> quality-report.md
          echo "**Timestamp:** $(date)" >> quality-report.md
          echo "" >> quality-report.md
          echo "### âœ… Checks Completed:" >> quality-report.md
          echo "- ESLint code quality" >> quality-report.md
          echo "- TypeScript type checking" >> quality-report.md
          echo "- Code formatting (Prettier)" >> quality-report.md
          echo "- Security vulnerability scan" >> quality-report.md
          echo "- Expo configuration validation" >> quality-report.md
          echo "- Environment setup verification" >> quality-report.md

      - name: ğŸ“¤ Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ github.sha }}
          path: quality-report.md

  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ—ï¸ Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Test Expo build setup
        run: |
          echo "ğŸ—ï¸ Testing Expo build configuration..."

          # Export to test build setup without actually building
          npx expo export --output-dir ./dist-test --clear

          echo "âœ… Build setup test passed!"

      - name: ğŸ§¹ Cleanup test build
        run: rm -rf ./dist-test

  pr-status:
    name: ğŸ“¢ PR Status Update
    runs-on: ubuntu-latest
    needs: [quality-check, build-test]
    if: github.event_name == 'pull_request'

    steps:
      - name: âœ… Quality checks passed
        if: needs.quality-check.result == 'success' && needs.build-test.result == 'success'
        run: |
          echo "âœ… All quality checks passed!"
          echo "PR is ready for review ğŸš€"

      - name: âŒ Quality checks failed
        if: needs.quality-check.result == 'failure' || needs.build-test.result == 'failure'
        run: |
          echo "âŒ Quality checks failed!"
          echo "Please fix the issues before merging"
          exit 1

# Extension notes:
# 1. Add unit tests when implemented
# 2. Add code coverage reporting
# 3. Add performance testing
# 4. Add Slack/Discord notifications
# 5. Add automatic PR labeling
